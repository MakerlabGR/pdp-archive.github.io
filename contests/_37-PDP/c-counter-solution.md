---
layout: solution
codename: counter
---

## Επεξήγηση Εκφώνησης

Μας δίνεται ο κώδικας μιας τροποποιημένης δυαδικής αναζήτησης που επιστρέφει τον αριθμό των συγκρίσεων στοιχείων 
της ακολουθίας ακεραίων $$A$$ με έναν ακέραιο αριθμό αναζήτησης $$x$$. Ο αριθμός που επιστρέφεται 
ονομάζεται $$\mathit{counter}$$. Επίσης, μας δίνονται $$Q$$ ερωτήματα με κάθε ερώτημα να περιέχει 
ένα διάστημα συνεχόμενων ακεραίων αριθμών $$x$$ και ζητείται το άθροισμα των τιμών $$\mathit{counter}$$ 
που θα επέστρεφαν οι κλήσεις στην τροποποιημένη δυαδική αναζήτηση για κάθε ένα από 
τα $$x$$ που περιέχονται στο διάστημα.

**Θεωρεία:** στη δυαδική αναζήτηση έχουμε δύο δείκτες, την αριστερή και δεξιά θέση σε ένα 
ταξινομημένο (μονότονο) διάστημα αναζήτησης και κάνοντας επαναλήψεις, καταφέρνουμε να βρούμε 
το στοιχείο που μας ενδιαφέρει πολύ γρήγορα (σε λογαριθμικό χρόνο) ή διαπιστώνουμε ότι δεν υπάρχει τέτοιο στοιχείο. 
Κάθε επανάληψη, οδηγεί έναν από τους δυο δείκτες πιο κοντά στη απάντηση, προσπερνώντας το 
μισό διάστημα αναζήτησης ανάμεσα στους δυο δείκτες. Οι δείκτες θα συγκλίνουν τελικά στο στοιχείο που ψάχνουμε ή 
θα διασταυρωθούν αν δεν υπάρχει τέτοιο στοιχείο.  
Υπάρχουν και άλλες παραλλαγές της παραπάνω δυαδικής αναζήτησης, όπως να βρούμε την πρώτη ή τελευταία εμφάνιση ενός αριθμού 
σε μια μονότονη ακολουθία ή και να κάνουμε αναζήτηση όχι σε πίνακα με αριθμούς αλλά σε νοητούς αριθμούς που 
αποτελούν αποτέλεσμα υπολογισμών (αρκεί τα αποτελέσματα αυτά να έχουν μόνο αύξουσα ή μόνο φθίνουσα σειρά).
Παραδείγματα τέτοιων προβλημάτων: [roadworks](https://pdp-archive.github.io/26-PDP/c-roadwork-solution), 
[filiki](https://pdp-archive.github.io/34-PDP/c-filiki-statement), 
[agrycows](https://www.spoj.com/problems/AGGRCOW/). 

## Υποπρόβλημα 1 ($$L_1 = R_1$$)

Σε αυτό το υποπρόβλημα κάθε ερώτημα περιέχει μόνο έναν αριθμό $$x$$, άρα αρκεί να υπολογίσουμε το $$\text{counter}$$ 
για κάθε ερώτημα. Ο χρόνος που απαιτείται για κάθε ερώτημα είναι $$\mathcal{O}(\log_2{N})$$, 
άρα στα $$Q$$ ερωτήματα είναι $$\mathcal{O}(Q \cdot \log_2{N})$$. 
Μπορείτε να δείτε τον κώδικα [εδώ]({% include link_to_source.md solution_name='counter_sub1.cc' %}). 

## Υποπρόβλημα 2 (ερωτήματα σε υπαρκτά στοιχεία μόνο)

Το διάστημα $$L_i, L_i+1, L_i+2,\ldots,R_i$$ είναι μια γνησίως αύξουσα 
ακολουθία αποτελούμενη από $$R_i-L_i+1$$ διαδοχικούς ακέραιους αριθμούς και στο υποπρόβλημα αυτό, 
γνωρίζουμε ότι αποτελούν υπαρκτές τιμές του $$A$$.  
Προϋπολογίσουμε τις τιμές $$\mathit{counter}$$ για κάθε στοιχείο $$A_i$$ και τις αποθηκεύουμε σε έναν πίνακα 
$$\mathit{c}$$. Για τον προϋπολογισμό απαιτείται χρόνος $$\mathcal{O}(N \cdot \log_2{N})$$. 
Κατόπιν, για κάθε query βρίσκουμε σε ποιά θέση $$j$$ έχουμε $$A_j = L_i$$ και σε ποιά θέση 
$$k$$ έχουμε $$A_k=R_i$$ κάνοντας binary search (με τις συναρτήσεις της *stl*: `lower_bound`, `upper_bound`), 
οι οποίες χρειάζονται χρόνο $$\mathcal{O}(\log_2{N})$$.  
Η απάντηση στο ερώτημα είναι το άθροισμα $$c_j + c_{j+1}+ c_{j+2} + \ldots + c_k$$ και θα χρειαστεί χρόνο $$\mathcal{O}(N)$$ 
για το άθροισμα του κάθε ερωτήματος (άρα συνολικός χρόνος $$\mathcal{O}(N \cdot log_2{N} + Q \cdot N \cdot \log_2{N})$$. 
Το άθροισμα του κάθε ερωτήματος μπορεί όμως να απαντηθεί σε $$\mathcal{O}(1)$$ με 
χρήση [prefix sum](https://en.wikipedia.org/wiki/Prefix_sum) οπότε ο συνολικός χρόνος του αλγορίθμου 
μειώνεται σε $$\mathcal{O}(N\cdot log_2{N}+Q\log_2{N})$$. 

{% include code.md solution_name='counter_sub2.cc' start=38 end=47 %}
Μπορείτε να δείτε ολόκληρο τον κώδικα [εδώ]({% include link_to_source.md solution_name='counter_sub2.cc' %}).

## Υποπρόβλημα 3 ($$A_{i+1}=A_i+1$$)

Το υποπρόβλημα αυτό μοιάζει με το προηγούμενο, καθώς και εκεί είχαμε διαδοχικά στοιχεία στα διαστήματα 
των ερωτημάτων του $$A$$. Εδώ όμως τα διαστήματα μπορούν να επεκτείνονται και εκτός του $$A$$ άρα το κάθε ερώτημα μπορεί:
- να βρίσκεται ολόκληρο αριστερά του $$A$$ στην αριθμογραμμή,
- να βρίσκεται ολόκληρο εντός του $$A$$ (οπότε η απάντηση υπολογίζεται όπως στο προηγούμενο υποπρόβλημα)
- να βρίσκεται ολόκληρο δεξιότερα του $$A$$ 
- να συνδυάζει ένα ή δύο τμήματα εκτός του $$A$$ και ένα εντός του $$A$$.

**Παρατήρηση:** αν σε κάποια επανάληψη της δυαδικής αναζήτησης το διάστημα του $$A$$ που εξετάζουμε δεν 
έχει περιττό αριθμό στοιχείων, η τιμή $$\mathit{m}=(\mathit{l}+\mathit{r})/2$$ θα κόψει τον πίνακα σε δύο άνισα 
διαστήματα (το αριστερό τμήμα $$A_l, A_{l+1}, \ldots, A_{m-1}$$ θα έχει ένα στοιχείο λιγότερο από το δεξιό 
$$A_{m+1}, A_{m+2}, \ldots, A_r$$ λόγω της στρογγυλοποίησης προς τα κάτω που κάνει η ακέραια διαίρεση. 
Αυτό θα έχει σαν αποτέλεσμα αν το $$x$$ που αναζητούμε δεν βρίσκεται στον πίνακα 
μας, να χρειαστεί διαφορετικό αριθμό επαναλήψεων (και να παράγει διαφορετική τιμή $$\mathit{counter}$$) μέχρι να βρούμε 
ότι βρίσκεται αριστερότερα όλων των στοιχείων του $$A$$ ή δεξιότερα τους. 

Υπολογίζουμε τις δύο επιπλέον τιμές $$\mathit{leftout}$$ και $$\mathit{rightout}$$ για να αξιοποιήσουμε 
την παραπάνω παρατήρηση:
{% include code.md solution_name='counter_sub3.cc' start=38 end=64 %}
Ο αλγόριθμος χρειάζεται χρόνο $$\mathcal{O}(N\cdot log_2{N}+Q\log_2{N})$$. 
Μπορείτε να δείτε ολόκληρο τον κώδικα [εδώ]({% include link_to_source.md solution_name='counter_sub3.cc' %}).

## Υποπρόβλημα 4 ($$N=2^{K-1}$$)

Στο υποπρόβλημα αυτό, τα δύο διαστήματα που προκύπτουν σε κάθε επανάληψη της δυαδικής αναζήτησης είναι ίσα και 
μάλιστα έχουν διάσταση $$2^{k-2}$$ μετά την πρώτη επανάληψη, $$2^{k-3}$$ μετά τη δεύτερη επανάληψη κλπ. Άρα χρειαζόμαστε 
σταθερό αριθμό επαναλήψεων μέχρι να διασταυρωθούν οι δείκτες για την αναζήτηση οποιουδήποτε στοιχείου δεν υπάρχει στον $$A$$. 
Για το υποπρόβλημα αυτό αρκεί να βρούμε πόσοι αριθμοί στο ερώτημα υπάρχουν στον $$A$$ και πόσοι όχι.  
{% include code.md solution_name='counter_sub4.cc' start=42 end=54 %}
Ο αλγόριθμος χρειάζεται χρόνο $$\mathcal{O}(N\cdot log_2{N}+Q\log_2{N})$$. 
Μπορείτε να δείτε ολόκληρο τον κώδικα [εδώ]({% include link_to_source.md solution_name='counter_sub4.cc' %}).

## Υποπρόβλημα 5 ($$Q=1$$)

Έχοντας μόνο ένα ερώτημα, θα ξεκινήσουμε να κάνουμε τη δυαδική αναζήτηση ταυτόχρονα για όλα τα στοιχεία του ερωτήματος χωρίζοντας το 
διάστημα $$[L,R]$$ διαρκώς στη μέση και συνεχίζοντας αναδρομικά για τα δύο νέα διαστήματα. 
Η μέθοδος αυτή της διαίρεσης του γενικού προβλήματος σε μικρότερα όμοια προβλήματα μέχρι την τελική λύση, 
ονομάζεται *divide and conquer* (διαίρει και βασίλευε).  
Ξεκινάμε με $$\mathit{counter}=1$$ και σε κάθε βήμα τις αναδρομής, γνωρίζουμε ότι ανακαλύπτουμε 
το $$A[\mathit{mid}]$$ (με $$\mathit{mid}=(\mathit{leftpos}+\mathit{rightpos})/2$$) και ξεκινάμε 
αναδρομή στα δυο διαστήματα αριστερά και δεξιά 
του $$A[\mathit{mid}]$$ αλλά με τιμή $$\mathit{counter}=\mathit{counter}+1$$. Προσοχή χρειάζεται στο τέλος της αναδρομής, όταν 
διασταυρωθούν οι δείκτες της αριστερής και δεξιάς θέσης του διαστήματος, διότι το $$\mathit{counter}$$ δεν αυξάνεται 
στη διασταύσωση των δεικτών αλλά μόνο στη σύγκριση $$A_{\mathit{mid}}=x$$ όπως μπορούμε να δούμε στον ψευδοκώδικα της εκφώνησης.

{% include code.md solution_name='counter_sub5.cc' start=11 end=23 %}
Ο αλγόριθμος χρειάζεται χρόνο $$\mathcal{O}(N\cdot log_2{N})$$. 
Μπορείτε να δείτε ολόκληρο τον κώδικα [εδώ]({% include link_to_source.md solution_name='counter_sub5.cc' %}).

## Πλήρης λύση

Επεκτείνοντας τη λογική του προηγούμενου υποπροβλήματος, θα υπολογίσουμε όλα τα διαστήματα συνεχόμενων ανύπαρκτων 
αριθμών στον πίνακα $$A$$. Δηλαδή έστω ότι έχουμε $$A_i=4$$ και $$A_{i+1}=11$$. Το διάστημα με τους αριθμούς 
$$5,6,7,8,9,10$$ είναι ένα διάστημα συνεχόμενων ανύπαρκτων αριθμών στον πίνακα $$A$$. Η δυαδική αναζήτηση 
για οποιονδήποτε από τους παραπάνω αριθμούς, θα έφτανε μετά από κάποιες επαναλήψεις να έχει $$\mathit{leftpos}=i$$ και 
$$\mathit{rightpos}=i+1$$. Καθώς ο αριθμός που αναζητούμε δεν υπάρχει, η επόμενη επανάληψη θα καταλήξει με διασταυρωμένα 
$$\mathit{leftpos}$$ και $$\mathit{rightpos}$$ (δηλαδή $$\mathit{leftpos}\gt \mathit{rightpos}$$ και θα τέλειωναν 
οι επαναλήψεις με την τρέχουσα τιμή του $$\mathit{counter}$$. Γνωρίζοντας σε κάθε διάστημα συνεχόμενων ανύπαρκτων αριθμών, 
πόσοι είναι αυτοί, μπορούμε να τους προσθέσουμε στα prefix sum που χρησιμοποιήσαμε στα υποπροβλήματα 2,3,4 και να 
έχουμε την πλήρη λύση.

{% include code.md solution_name='counter_full1.cc' start=37 end=74 %}
Ο αλγόριθμος χρειάζεται χρόνο $$\mathcal{O}(N\cdot log_2{N} + Q \cdot log_2{N})$$. 
Μπορείτε να δείτε ολόκληρο τον κώδικα [εδώ]({% include link_to_source.md solution_name='counter_full1.cc' %}).

Σε κάθε διάστημα ανύπαρκτων αριθμών, δεν χρειάζεται να καλέσουμε τη `bsearch`, καθώς είναι φανερό ότι θα ανακαλύψουμε τους 
ανύπαρκτους αυτούς αριθμούς αφού διασταυρωθούν οι δείκτες των δύο υπαρκτών αριθμών που περιέχουν το διάστημα αυτό. 
Άρα η τιμή $$\mathit{counter}$$ των ανύπαρκτων αριθμών του διαστήματος, ισούται με τη μεγαλύτερη τιμή 
των $$\mathit{counter}$$ των δύο υπαρκτών αριθμών που περιέχουν το διάστημα. Με την παρατήρηση αυτή, μειώνουμε τον 
αριθμό των κλήσεων στη συνάρτηση `bsearch` σε μόλις $$N+2$$. 
Μπορείτε να δείτε τον σχετικό κώδικα [εδώ]({% include link_to_source.md solution_name='counter_full2.cc' %}).
